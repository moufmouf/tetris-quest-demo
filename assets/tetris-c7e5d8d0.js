(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(r){if(r.ep)return;r.ep=!0;const l=n(r);fetch(r.href,l)}})();let g="https://admin.workadventu.re";function T(t){g=t}function y(){const t=WA.player.userRoomToken;if(t===void 0)throw new Error("No userRoomToken found. The quests plugin can only work with WorkAdventure SAAS edition (at https://play.workadventu.re).");return t}async function O(t,e){if(!WA.player.isLogged)throw new Error("You must be logged to gain XP.");const n=new URL(`/api/quests/${t}/level-up`,g),i=await fetch(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:y()},body:JSON.stringify({xp:e})});if(!i.ok)throw new Error(`An error occurred. HTTP Code: ${i.status} ${i.statusText}.`);const r=await i.json();return r.awardedBadges.length>0&&(async()=>{for(const l of r.awardedBadges)await b(t,l)})().catch(l=>{console.error(l)}),r}async function b(t,e){const n=new URL(`/quests/${t}/badge/${e}/congratulations`,g);n.search=new URLSearchParams({token:y()}).toString(),await WA.ui.website.open({url:n.toString(),position:{vertical:"middle",horizontal:"middle"},allowApi:!0,visible:!0,size:{width:"100%",height:"100%"}})}T("https://admin.staging.workadventu.re/");function L(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function R(){const t=["I","J","L","O","S","T","Z"];for(;t.length;){const e=L(0,t.length-1),n=t.splice(e,1)[0];d.push(n)}}function A(){d.length===0&&R();const t=d.pop(),e=I[t],n=a[0].length/2-Math.ceil(e[0].length/2);return{name:t,matrix:e,row:t==="I"?-1:-2,col:n}}function q(t){const e=t.length-1;return t.map((i,r)=>i.map((l,u)=>t[e-u][r]))}function h(t,e,n){for(let i=0;i<t.length;i++)for(let r=0;r<t[i].length;r++)if(t[i][r]&&(n+r<0||n+r>=a[0].length||e+i>=a.length||a[e+i][n+r]))return!1;return!0}function S(){for(let e=0;e<o.matrix.length;e++)for(let n=0;n<o.matrix[e].length;n++)if(o.matrix[e][n]){if(o.row+e<0)return E();a[o.row+e][o.col+n]=o.name}let t=0;for(let e=a.length-1;e>=0;)if(a[e].every(n=>!!n)){t++;for(let n=e;n>=0;n--)for(let i=0;i<a[n].length;i++)a[n][i]=a[n-1][i]}else e--;t&&WA.onInit().then(()=>{console.log("On init done"),O("TETRIS",t).catch(e=>console.error(e))}),o=A()}function E(){cancelAnimationFrame(w),v=!0,c.fillStyle="black",c.globalAlpha=.75,c.fillRect(0,f.height/2-30,f.width,60),c.globalAlpha=1,c.fillStyle="white",c.font="36px monospace",c.textAlign="center",c.textBaseline="middle",c.fillText("GAME OVER!",f.width/2,f.height/2)}const f=document.getElementById("game"),c=f.getContext("2d"),s=32,d=[],a=[];for(let t=-2;t<20;t++){a[t]=[];for(let e=0;e<10;e++)a[t][e]=0}const I={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]]},m={I:"cyan",O:"yellow",T:"purple",S:"green",Z:"red",J:"blue",L:"orange"};let p=0,o=A(),w=null,v=!1;function x(){w=requestAnimationFrame(x),c.clearRect(0,0,f.width,f.height);for(let t=0;t<20;t++)for(let e=0;e<10;e++)if(a[t][e]){const n=a[t][e];c.fillStyle=m[n],c.fillRect(e*s,t*s,s-1,s-1)}if(o){++p>35&&(o.row++,p=0,h(o.matrix,o.row,o.col)||(o.row--,S())),c.fillStyle=m[o.name];for(let t=0;t<o.matrix.length;t++)for(let e=0;e<o.matrix[t].length;e++)o.matrix[t][e]&&c.fillRect((o.col+e)*s,(o.row+t)*s,s-1,s-1)}}document.addEventListener("keydown",function(t){if(!v){if(t.which===37||t.which===39){const e=t.which===37?o.col-1:o.col+1;h(o.matrix,o.row,e)&&(o.col=e)}if(t.which===38){const e=q(o.matrix);h(e,o.row,o.col)&&(o.matrix=e)}if(t.which===40){const e=o.row+1;if(!h(o.matrix,e,o.col)){o.row=e-1,S();return}o.row=e}}});w=requestAnimationFrame(x);
