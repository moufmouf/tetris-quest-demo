(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function r(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(n){if(n.ep)return;n.ep=!0;const l=r(n);fetch(n.href,l)}})();let g="https://admin.workadventu.re";function T(e){g=e}function y(){const e=WA.player.userRoomToken;if(e===void 0)throw new Error("No userRoomToken found. The quests plugin can only work with WorkAdventure SAAS edition (at https://play.workadventu.re).");return e}async function O(e,t){if(!WA.player.isLogged)throw new Error("You must be logged to gain XP.");const r=new URL(`/api/quests/${e}/level-up`,g),i=await fetch(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:y()},body:JSON.stringify({xp:t})});if(!i.ok)throw new Error(`An error occurred. HTTP Code: ${i.status} ${i.statusText}.`);const n=await i.json();return n.awardedBadges.length>0&&(async()=>{for(const l of n.awardedBadges)await L(e,l)})().catch(l=>{console.error(l)}),n}async function L(e,t){const r=new URL(`/quests/${e}/badge/${t}/congratulations`,g);r.search=new URLSearchParams({token:y()}).toString(),await WA.ui.website.open({url:r.toString(),position:{vertical:"middle",horizontal:"middle"},allowApi:!0,visible:!0,size:{width:"100%",height:"100%"}})}T("https://staging.workadventu.re/");function b(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function R(){const e=["I","J","L","O","S","T","Z"];for(;e.length;){const t=b(0,e.length-1),r=e.splice(t,1)[0];d.push(r)}}function A(){d.length===0&&R();const e=d.pop(),t=I[e],r=a[0].length/2-Math.ceil(t[0].length/2);return{name:e,matrix:t,row:e==="I"?-1:-2,col:r}}function q(e){const t=e.length-1;return e.map((i,n)=>i.map((l,u)=>e[t-u][n]))}function h(e,t,r){for(let i=0;i<e.length;i++)for(let n=0;n<e[i].length;n++)if(e[i][n]&&(r+n<0||r+n>=a[0].length||t+i>=a.length||a[t+i][r+n]))return!1;return!0}function S(){for(let t=0;t<o.matrix.length;t++)for(let r=0;r<o.matrix[t].length;r++)if(o.matrix[t][r]){if(o.row+t<0)return E();a[o.row+t][o.col+r]=o.name}let e=0;for(let t=a.length-1;t>=0;)if(a[t].every(r=>!!r)){e++;for(let r=t;r>=0;r--)for(let i=0;i<a[r].length;i++)a[r][i]=a[r-1][i]}else t--;e&&O("TETRIS",e),o=A()}function E(){cancelAnimationFrame(w),v=!0,c.fillStyle="black",c.globalAlpha=.75,c.fillRect(0,f.height/2-30,f.width,60),c.globalAlpha=1,c.fillStyle="white",c.font="36px monospace",c.textAlign="center",c.textBaseline="middle",c.fillText("GAME OVER!",f.width/2,f.height/2)}const f=document.getElementById("game"),c=f.getContext("2d"),s=32,d=[],a=[];for(let e=-2;e<20;e++){a[e]=[];for(let t=0;t<10;t++)a[e][t]=0}const I={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]]},m={I:"cyan",O:"yellow",T:"purple",S:"green",Z:"red",J:"blue",L:"orange"};let p=0,o=A(),w=null,v=!1;function x(){w=requestAnimationFrame(x),c.clearRect(0,0,f.width,f.height);for(let e=0;e<20;e++)for(let t=0;t<10;t++)if(a[e][t]){const r=a[e][t];c.fillStyle=m[r],c.fillRect(t*s,e*s,s-1,s-1)}if(o){++p>35&&(o.row++,p=0,h(o.matrix,o.row,o.col)||(o.row--,S())),c.fillStyle=m[o.name];for(let e=0;e<o.matrix.length;e++)for(let t=0;t<o.matrix[e].length;t++)o.matrix[e][t]&&c.fillRect((o.col+t)*s,(o.row+e)*s,s-1,s-1)}}document.addEventListener("keydown",function(e){if(!v){if(e.which===37||e.which===39){const t=e.which===37?o.col-1:o.col+1;h(o.matrix,o.row,t)&&(o.col=t)}if(e.which===38){const t=q(o.matrix);h(t,o.row,o.col)&&(o.matrix=t)}if(e.which===40){const t=o.row+1;if(!h(o.matrix,t,o.col)){o.row=t-1,S();return}o.row=t}}});w=requestAnimationFrame(x);
