(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function r(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(n){if(n.ep)return;n.ep=!0;const l=r(n);fetch(n.href,l)}})();let p="https://admin.workadventu.re";function y(){const t=WA.player.userRoomToken;if(t===void 0)throw new Error("No userRoomToken found. The quests plugin can only work with WorkAdventure SAAS edition (at https://play.workadventu.re).");return t}async function T(t,e){if(!WA.player.isLogged)throw new Error("You must be logged to gain XP.");const r=new URL(`/api/quests/${t}/level-up`,p),i=await fetch(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:y()},body:JSON.stringify({xp:e})});if(!i.ok)throw new Error(`An error occurred. HTTP Code: ${i.status} ${i.statusText}.`);const n=await i.json();return n.awardedBadges.length>0&&(async()=>{for(const l of n.awardedBadges)await O(t,l)})().catch(l=>{console.error(l)}),n}async function O(t,e){const r=new URL(`/quests/${t}/badge/${e}/congratulations`,p);r.search=new URLSearchParams({token:y()}).toString(),await WA.ui.website.open({url:r.toString(),position:{vertical:"middle",horizontal:"middle"},allowApi:!0,visible:!0,size:{width:"100%",height:"100%"}})}function b(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function L(){const t=["I","J","L","O","S","T","Z"];for(;t.length;){const e=b(0,t.length-1),r=t.splice(e,1)[0];d.push(r)}}function A(){d.length===0&&L();const t=d.pop(),e=E[t],r=a[0].length/2-Math.ceil(e[0].length/2);return{name:t,matrix:e,row:t==="I"?-1:-2,col:r}}function R(t){const e=t.length-1;return t.map((i,n)=>i.map((l,u)=>t[e-u][n]))}function h(t,e,r){for(let i=0;i<t.length;i++)for(let n=0;n<t[i].length;n++)if(t[i][n]&&(r+n<0||r+n>=a[0].length||e+i>=a.length||a[e+i][r+n]))return!1;return!0}function S(){for(let e=0;e<o.matrix.length;e++)for(let r=0;r<o.matrix[e].length;r++)if(o.matrix[e][r]){if(o.row+e<0)return q();a[o.row+e][o.col+r]=o.name}let t=0;for(let e=a.length-1;e>=0;)if(a[e].every(r=>!!r)){t++;for(let r=e;r>=0;r--)for(let i=0;i<a[r].length;i++)a[r][i]=a[r-1][i]}else e--;t&&T("TETRIS",t).catch(e=>console.error(e)),o=A()}function q(){cancelAnimationFrame(w),x=!0,c.fillStyle="black",c.globalAlpha=.75,c.fillRect(0,f.height/2-30,f.width,60),c.globalAlpha=1,c.fillStyle="white",c.font="36px monospace",c.textAlign="center",c.textBaseline="middle",c.fillText("GAME OVER!",f.width/2,f.height/2)}const f=document.getElementById("game"),c=f.getContext("2d"),s=32,d=[],a=[];for(let t=-2;t<20;t++){a[t]=[];for(let e=0;e<10;e++)a[t][e]=0}const E={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]]},g={I:"cyan",O:"yellow",T:"purple",S:"green",Z:"red",J:"blue",L:"orange"};let m=0,o=A(),w=null,x=!1;function v(){w=requestAnimationFrame(v),c.clearRect(0,0,f.width,f.height);for(let t=0;t<20;t++)for(let e=0;e<10;e++)if(a[t][e]){const r=a[t][e];c.fillStyle=g[r],c.fillRect(e*s,t*s,s-1,s-1)}if(o){++m>35&&(o.row++,m=0,h(o.matrix,o.row,o.col)||(o.row--,S())),c.fillStyle=g[o.name];for(let t=0;t<o.matrix.length;t++)for(let e=0;e<o.matrix[t].length;e++)o.matrix[t][e]&&c.fillRect((o.col+e)*s,(o.row+t)*s,s-1,s-1)}}document.addEventListener("keydown",function(t){if(!x){if(t.which===37||t.which===39){const e=t.which===37?o.col-1:o.col+1;h(o.matrix,o.row,e)&&(o.col=e)}if(t.which===38){const e=R(o.matrix);h(e,o.row,o.col)&&(o.matrix=e)}if(t.which===40){const e=o.row+1;if(!h(o.matrix,e,o.col)){o.row=e-1,S();return}o.row=e}}});w=requestAnimationFrame(v);
